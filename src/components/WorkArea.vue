<template>
    <div class="work_title">工作区</div>
    <el-table ref="multipleTableRef" :data="tableData" style="width: 100%" @selection-change="handleSelectionChange"
        :show-header=false>
        <el-table-column type="selection" width="40" />
        <el-table-column property="channel" label="操作" width="95" />
        <el-table-column fixed="right" label="设置" width="50">
            <template #default="scope">
                <el-button link type="primary" size="small" @click="clickObject(scope.row.id)">设置</el-button>
            </template>
        </el-table-column>
    </el-table>
    <div class="query_button"><el-button @click="sendWork">查看</el-button></div>
    <div class="select">
        <div>特征提取频道选择:</div>
        <el-select v-model="curChannel" placeholder="Select" size="small">
            <el-option v-for="item in options" :key="item.value" :label="item.label" :value="item.value" />
        </el-select>
    </div>
    <div class="set_center"><el-button :icon="Position" size="large" type="primary" color="#626aef"
            @click.prevent="onOnlineAnalysis">在线分析</el-button></div>
    <!-- 模态框部分-->
    <!-- 1.降采样  -->
    <el-dialog v-model="chooseDialog.isDownSampling" title="降采样" width="30%">
        <el-form :model="ruleForm">
            <el-form-item label="间隔个数" :label-width="formLabelWidth">
                <el-input v-model.number="workInput.DownSampling" autocomplete="off" style="width: 50px" />
            </el-form-item>
        </el-form>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="chooseDialog.isDownSampling = false">取消</el-button>
                <el-button type="primary" @click="setDownSampling(workInput.DownSampling)">
                    确认
                </el-button>
            </span>
        </template>
    </el-dialog>
    <!-- 2.仪器去响应 -->
    <el-dialog v-model="chooseDialog.isGoRespond" title="仪器去响应" width="30%">
        <el-form-item label="仪器灵敏度" :label-width="formLabelWidth">
            <el-input v-model.number="workInput.GoRespond" autocomplete="off" style="width: 50px" />
        </el-form-item>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="chooseDialog.isGoRespond = false">取消</el-button>
                <el-button type="primary" @click="setGoRespond(workInput.GoRespond)">
                    确认
                </el-button>
            </span>
        </template>
    </el-dialog>
    <!-- 3.归一化 -->
    <el-dialog v-model="chooseDialog.isNormalization" title="归一化" width="30%">
        <el-form-item label="归一化方法" :label-width="formLabelWidth">
            <el-select v-model="workInput.Normalization" placeholder="Please select a zone">
                <el-option label="均值归一化" value="zero_center" />
                <el-option label="标准化" value="zs_score" />
                <el-option label="零一归一化" value="rescale_zero_one" />
                <el-option label="无操作" value="none" />
            </el-select>
        </el-form-item>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="chooseDialog.isNormalization = false">取消</el-button>
                <el-button type="primary" @click="setNormalization(workInput.Normalization)">
                    确认
                </el-button>
            </span>
        </template>
    </el-dialog>
    <!-- 4.滤波 -->
    <el-dialog v-model="chooseDialog.isFiltering" title="滤波" width="30%">
        <el-form-item label="滤波器：" label-width=100px>
            <el-select v-model="workInput.filter" placeholder="Please select a zone">
                <el-option label="巴特沃斯带通滤波器" value="bandpass" />
                <el-option label="巴特沃斯高通滤波器" value="highpass" />
                <el-option label="巴特沃斯低通滤波器" value="lowpass" />
            </el-select>
        </el-form-item>
        <el-form-item label="参数设置： " :label-width="formLabelWidth2"></el-form-item>
        <div v-if="workInput.filter == 'bandpass'">
            <el-form-item label="通带低转角频率：" :label-width="formLabelWidth2">
                <el-input v-model="workFilterProps.freqmin" autocomplete="off" style="width: 100px" />
            </el-form-item>
            <el-form-item label="通带高转角转角频率：" :label-width="formLabelWidth2">
                <el-input v-model="workFilterProps.freqmax" autocomplete="off" style="width: 100px" />
            </el-form-item>
        </div>
        <div v-else>
            <el-form-item label="滤波器转角频率：" :label-width="formLabelWidth2">
                <el-input v-model="workFilterProps.freq" autocomplete="off" style="width: 100px" />
            </el-form-item>
        </div>

        <el-form-item label="采样率(Hz)：" :label-width="formLabelWidth2">
            <el-input v-model="workFilterProps.df" autocomplete="off" style="width: 100px" />
        </el-form-item>
        <el-form-item label="过滤角点/顺序：" :label-width="formLabelWidth2">
            <el-input v-model="workFilterProps.corners" autocomplete="off" style="width: 100px" />
        </el-form-item>
        <el-form-item label="zerophase：" :label-width="formLabelWidth2">
            <el-input v-model="workFilterProps.zerophase" autocomplete="off" style="width: 100px" />
        </el-form-item>
        <template #footer>
            <span class="dialog-footer">
                <el-button @click="chooseDialog.isFiltering = false">取消</el-button>
                <el-button type="primary" @click="setFilter(workInput.filter)">
                    确认
                </el-button>
            </span>
        </template>
    </el-dialog>
</template>

<script lang="ts" setup>
import router from '@/router'
import { Search, Position } from '@element-plus/icons-vue'
import { onMounted, reactive, ref, watch } from 'vue'
import { ElTable } from 'element-plus'
import { useStore } from 'vuex'
import { GlobalDataProps } from '../store'
import { computed } from '@vue/reactivity'
import type { FormInstance, FormRules } from 'element-plus'
const store = useStore<GlobalDataProps>()
const workInput = reactive(computed(() => store.state.workChoose))
const choosedchannels = reactive(computed(() => store.state.chooseChannel))
const workFilterProps = reactive(computed(() => store.state.workFilterProps))
const options: { value: string; label: string }[] = reactive([])

const ruleForm = reactive({
    number: '',
    region: '',
    count: '',
    date1: '',
    date2: '',
    delivery: false,
    type: [],
    resource: '',
    desc: ''
})

watch(choosedchannels, (choosedchannels) => {
    options.length = 0
    choosedchannels.forEach(x => {
        options.push({
            value: x,
            label: x
        })
    })
    if (options.length > 0) {
       curChannel.value = options[0].value
    }
}, { deep: true })

interface Curve {
    id: number
    name: string
    channel: string
}

// const value = reactive(computed(() => choosedchannels.value.length > 0 ? choosedchannels.value[0] : ''))
const curChannel = ref('')
// onMounted(
//     () => {
//         curChannel.value = options[0].value
//     }
// )
watch(() => curChannel.value, (value) => {
    store.commit('changeFeatureChannel', value)
    store.commit('changeFeatureInfo')
})
const multipleTableRef = ref<InstanceType<typeof ElTable>>()
const multipleSelection = ref<Curve[]>([])
const handleSelectionChange = (val: Curve[]) => {
    console.log('操作选择： ', val)
    multipleSelection.value = val
}
const sendWork = () => {
    const arr: string[] = []
    multipleSelection.value.forEach(x => {
        arr.push(x.name)
    })
    store.commit('changeworkChoosedName', arr)
    // store.dispatch('fetchWorkData')
    store.dispatch('fetchTimeDomainInfo')
        .then(
            () => store.dispatch('fetchFrequencyDomainInfo'))
        .then(
            () => store.dispatch('fetchTimeFrequencyInfo')
        )
        .then(
            () => store.dispatch('fetchFeatureExtractionInfo')
        )
}
const chooseDialog = reactive({
    isDownSampling: false,
    isGoRespond: false,
    isNormalization: false,
    isFiltering: false
})

const clickObject = (id: number) => {
    switch (id) {
        case 1:
            chooseDialog.isDownSampling = true
            break
        case 2:
            chooseDialog.isGoRespond = true
            break
        case 3:
            chooseDialog.isNormalization = true
            break
        case 4:
            chooseDialog.isFiltering = true
            break
        default:
            break
    }
}

const setDownSampling = (n: number) => {
    store.commit('changeDownSampling', n)
    chooseDialog.isDownSampling = false
}
const setGoRespond = (n: number) => {
    store.commit('changeGoRespond', n)
    chooseDialog.isGoRespond = false
}
const setNormalization = (n: string) => {
    store.commit('changeNormalization', n)
    chooseDialog.isNormalization = false
}
const setFilter = (n: string) => {
    store.commit('changeWorkFilter', n)
    store.commit('changeWorkFilterProps', workFilterProps)
    chooseDialog.isFiltering = false
}

const tableData: Curve[] = [
    {
        id: 1,
        name: 'DownSampling',
        channel: '降采样'
    },
    {
        id: 2,
        name: 'GoRespond',
        channel: '仪器去响应'
    },
    {
        id: 3,
        name: 'Normalization',
        channel: '归一化'
    },
    {
        id: 4,
        name: 'Filtering',
        channel: '滤波'
    }
]

const formLabelWidth = '100px'
const formLabelWidth2 = '170px'

const onOnlineAnalysis = () => {
    router.push('/online/mapView')
}

const toggleSelection = (rows?: Curve[]) => {
    if (rows) {
        rows.forEach((row) => {
            // TODO: improvement typing when refactor table
            // eslint-disable-next-line @typescript-eslint/ban-ts-comment
            // @ts-expect-error
            multipleTableRef.value!.toggleRowSelection(row, undefined)
        })
    } else {
        multipleTableRef.value!.clearSelection()
    }
}
onMounted(() => {
    const chooseChannel = store.state.workChoosedName
    const arr: Curve[] = []
    chooseChannel.forEach(x => {
        tableData.forEach(data => {
            if (data.name === x) {
                arr.push(data)
            }
        })
    })
    toggleSelection(arr)
})

</script>

<style>
.set_center {
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;

}

.select {
    font-size: 14px;
    display: grid;
    grid-template-columns: 2fr 1fr;
}

.query_button {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 5px;
    padding: 2px;
    border-bottom: 1px solid #909399;
}

.work_title {
    font-size: 16px;
    font-weight: bold;
    color: #909399;
    text-align: center;
    height: 35px;
    line-height: 35px;
    border-bottom: 1px solid;
}
</style>
